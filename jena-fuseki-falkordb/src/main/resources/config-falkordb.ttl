# FalkorDB + Eager Inference + GeoSPARQL Configuration
#
# ARCHITECTURE (The "Three-Layer Onion"):
# ---------------------------
# Level 1 (Top): GeoSPARQL Dataset (<#geospatial_dataset>)
#       - Intercepts spatial queries (e.g., geof:sfWithin)
#       - Wraps the Inference Model
#
# Level 2 (Middle): Inference Model (<#inf_model>)
#       - Runs in 'forward' (eager) mode
#       - Immediately materializes "grandfather" triples when "father" triples are added
#       - Wraps the FalkorDB Model
#
# Level 3 (Bottom): FalkorDB Model (<#falkor_model>)
#       - Physical storage layer
#       - Connects to Redis/FalkorDB
#
# To use this configuration:
# 1. Start FalkorDB: docker run -p 6379:6379 -it --rm falkordb/falkordb:latest
# 2. Run Fuseki with this config: 
#    java -jar jena-fuseki-falkordb.jar --config config-falkordb.ttl
#
# Prerequisites:
# - FalkorDB must be running on localhost:6379 (or as configured below)
# - The jena-fuseki-falkordb JAR must include the assembler module

@prefix :          <#> .
@prefix fuseki:    <http://jena.apache.org/fuseki#> .
@prefix rdf:       <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs:      <http://www.w3.org/2000/01/rdf-schema#> .
@prefix ja:        <http://jena.hpl.hp.com/2005/11/Assembler#> .
@prefix falkor:    <http://falkordb.com/jena/assembler#> .
@prefix geosparql: <http://jena.apache.org/geosparql#> .

# Declare FalkorDBModel as a subclass of ja:Model for assembler compatibility
falkor:FalkorDBModel rdfs:subClassOf ja:Model .

# Fuseki server configuration
[] rdf:type fuseki:Server ;
   fuseki:services (
     :service
   ) .

# The FalkorDB-backed service with three-layer onion architecture
:service rdf:type fuseki:Service ;
    # Service name - endpoint will be available at /falkor
    fuseki:name "falkor" ;
    
    # SPARQL query endpoint
    fuseki:endpoint [
        fuseki:operation fuseki:query ;
        fuseki:name "sparql"
    ] ;
    fuseki:endpoint [
        fuseki:operation fuseki:query ;
        fuseki:name "query"
    ] ;
    
    # SPARQL update endpoint
    fuseki:endpoint [
        fuseki:operation fuseki:update ;
        fuseki:name "update"
    ] ;
    
    # Graph Store Protocol (read-only)
    fuseki:endpoint [
        fuseki:operation fuseki:gsp-r ;
        fuseki:name "get"
    ] ;
    
    # Graph Store Protocol (read-write)
    fuseki:endpoint [
        fuseki:operation fuseki:gsp-rw ;
        fuseki:name "data"
    ] ;
    
    # Link to the GeoSPARQL dataset (outer layer)
    fuseki:dataset :geospatial_dataset .

# Level 1 (Outer Layer): GeoSPARQL Dataset Configuration
# This wraps the inference dataset with GeoSPARQL capabilities
# IMPORTANT: Using falkor:SafeGeosparqlDataset instead of geosparql:GeosparqlDataset
# to prevent spatial index building errors when restarting with existing data
:geospatial_dataset rdf:type falkor:SafeGeosparqlDataset ;
    # Enable GeoSPARQL inference (derives additional spatial relations)
    geosparql:inference            true ;
    
    # Enable query rewriting for optimization
    geosparql:queryRewrite         true ;
    
    # Enable spatial indexing - SafeGeosparqlDataset will handle errors gracefully
    # FalkorDB handles spatial operations natively via query pushdown
    # The SafeGeosparqlDataset catches errors during index building on restart
    geosparql:indexEnabled         true ;
    
    # Whether to apply default geometry to features
    geosparql:applyDefaultGeometry false ;
    
    # Spatial Reference System URI - uses WGS84 (latitude/longitude)
    # This is the default SRS for GeoSPARQL
    geosparql:srsUri               <http://www.opengis.net/def/crs/OGC/1.3/CRS84> ;

    # Base dataset with inference model (middle layer)
    geosparql:dataset :dataset_rdf .

# RDF Dataset wrapping the inference model
# This is needed because GeoSPARQL expects a Dataset, not a Model
:dataset_rdf rdf:type ja:RDFDataset ;
    ja:defaultGraph :inf_model .

# Level 2 (Middle Layer): Inference Model with Generic Rule Reasoner
# This model wraps the FalkorDB base model and applies forward chaining rules
# Forward chaining (eager inference) materializes inferred triples immediately
# when new data is added
:inf_model rdf:type ja:InfModel ;
    ja:baseModel :falkor_model ;
    ja:reasoner [
        # Use Generic Rule Reasoner
        # See: https://jena.apache.org/documentation/inference/
        ja:reasonerURL <http://jena.hpl.hp.com/2003/GenericRuleReasoner> ;
        # Load forward chaining rules from file for eager inference
        # Forward rules materialize grandfather relationships immediately
        ja:rulesFrom <file:rules/grandfather_of_fwd.rule> ;
    ] .

# Level 3 (Core/Bottom Layer): FalkorDB-backed model configuration
# This is the physical storage layer
:falkor_model rdf:type falkor:FalkorDBModel ;
    # FalkorDB connection settings (all optional with defaults shown)
    falkor:host "localhost" ;  # Default: "localhost"
    falkor:port 6379 ;         # Default: 6379
    falkor:graphName "knowledge_graph" .  # Default: "rdf_graph"
