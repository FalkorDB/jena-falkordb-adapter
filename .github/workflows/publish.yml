name: Release
permissions:
  contents: read

on:
  release:
    types: [published]

jobs:
  build:
    runs-on: ubuntu-latest

    # Service containers to run with `test-job`
    services:
      # Label used to access the service container
      falkordb:
        # Docker Hub image
        image: falkordb/falkordb:edge
        # Map port 6379 on the Docker host to port 6379 on the FalkorDB container
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v5

      - name: Get version from tag
        id: get_version
        run: |
          realversion="${GITHUB_REF/refs\/tags\//}"
          realversion="${realversion//v/}"
          echo "VERSION=$realversion" >> $GITHUB_OUTPUT

      - name: Setup SDKMAN!
        run: |
          curl -s "https://get.sdkman.io" | bash
          source "$HOME/.sdkman/bin/sdkman-init.sh"
          sdk version

      - name: Install Java from .sdkmanrc
        run: |
          source "$HOME/.sdkman/bin/sdkman-init.sh"
          sdk env install
          java -version

      - name: Set up Maven cache
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Configure Maven settings for Maven Central
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << 'EOF'
          <settings>
            <servers>
              <server>
                <id>central</id>
                <username>${env.MAVEN_CENTRAL_USERNAME}</username>
                <password>${env.MAVEN_CENTRAL_TOKEN}</password>
              </server>
            </servers>
          </settings>
          EOF

      - name: Update version in POM
        run: |
          source "$HOME/.sdkman/bin/sdkman-init.sh"
          mvn versions:set -DnewVersion=${{ steps.get_version.outputs.VERSION }} -DprocessAllModules=true

      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.OSSH_GPG_SECRET_KEY }}
          passphrase: ${{ secrets.OSSH_GPG_SECRET_KEY_PASSWORD }}

      - name: Build and deploy to Maven Central
        run: |
          source "$HOME/.sdkman/bin/sdkman-init.sh"
          mvn --no-transfer-progress \
            --batch-mode \
            clean deploy
        env:
          MAVEN_CENTRAL_USERNAME: ${{ secrets.CENTRAL_USERNAME }}
          MAVEN_CENTRAL_TOKEN: ${{ secrets.CENTRAL_TOKEN }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.OSSH_GPG_SECRET_KEY_PASSWORD }}
